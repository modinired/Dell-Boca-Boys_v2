name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || github.event_name == 'workflow_dispatch'
    environment:
      name: staging
      url: https://staging.dell-boca-boys.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure Kubernetes context
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: Deploy to Kubernetes (Staging)
        run: |
          export KUBECONFIG=./kubeconfig

          # Update image in deployment
          kubectl set image deployment/orchestrator \
            orchestrator=ghcr.io/${{ github.repository }}:${{ github.sha }} \
            -n dell-boca-boys-staging

          # Wait for rollout
          kubectl rollout status deployment/orchestrator \
            -n dell-boca-boys-staging \
            --timeout=5m

      - name: Run smoke tests
        run: |
          STAGING_URL="https://staging.dell-boca-boys.example.com"

          # Health check
          curl -f ${STAGING_URL}/health || exit 1

          # Skill stats check
          STATS=$(curl -s ${STAGING_URL}/skills/stats)
          TOTAL_SKILLS=$(echo $STATS | jq -r '.total_skills')

          if [ "$TOTAL_SKILLS" -lt 80 ]; then
            echo "ERROR: Expected 80+ skills, got $TOTAL_SKILLS"
            exit 1
          fi

          echo "✓ Staging deployment successful - $TOTAL_SKILLS skills available"

  deploy-production:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/v')
    needs: [deploy-staging]
    environment:
      name: production
      url: https://dell-boca-boys.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure Kubernetes context
        run: |
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: Create database backup
        run: |
          export KUBECONFIG=./kubeconfig
          kubectl exec -n dell-boca-boys-production \
            deployment/postgres -- \
            pg_dump -U admin dell_boca_boys | \
            gzip > backup-$(date +%Y%m%d-%H%M%S).sql.gz

      - name: Deploy to Kubernetes (Production)
        run: |
          export KUBECONFIG=./kubeconfig

          # Update image in deployment
          kubectl set image deployment/orchestrator \
            orchestrator=ghcr.io/${{ github.repository }}:${{ github.sha }} \
            -n dell-boca-boys-production

          # Wait for rollout
          kubectl rollout status deployment/orchestrator \
            -n dell-boca-boys-production \
            --timeout=10m

      - name: Run production smoke tests
        run: |
          PROD_URL="https://dell-boca-boys.example.com"

          # Health check
          curl -f ${PROD_URL}/health || exit 1

          # Skill stats check
          STATS=$(curl -s ${PROD_URL}/skills/stats)
          TOTAL_SKILLS=$(echo $STATS | jq -r '.total_skills')

          if [ "$TOTAL_SKILLS" -lt 80 ]; then
            echo "ERROR: Expected 80+ skills, got $TOTAL_SKILLS"
            exit 1
          fi

          echo "✓ Production deployment successful - $TOTAL_SKILLS skills available"

      - name: Notify deployment
        if: always()
        run: |
          echo "Deployment to production completed"
          echo "Version: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

  rollback:
    runs-on: ubuntu-latest
    if: failure()
    needs: [deploy-production]

    steps:
      - name: Rollback production deployment
        run: |
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

          kubectl rollout undo deployment/orchestrator \
            -n dell-boca-boys-production

          kubectl rollout status deployment/orchestrator \
            -n dell-boca-boys-production \
            --timeout=5m

          echo "⚠️ Production rollback completed"
